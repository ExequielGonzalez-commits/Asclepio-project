<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
      <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.13.1/font/bootstrap-icons.min.css">
         <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/notyf@3/notyf.min.css">
      <link rel="stylesheet" href="css/style.css">
      <link rel="shortcut icon" href="imagenes/favicon-32x32.png" type="image/x-icon">
        
    <title>Asclepio project</title>
</head>
<body>
        <div class="titulo">
            <div class="logo-titulo">
                 <span class="logo"> <img src="imagenes/asclepio_2_logo.png" alt="" height="50"></span>
                <h1>Asclepio</h1>

            </div>
               
               
                <button id="button_darkMode"  class="btn-moon">
                      <i class="bi bi-moon"></i>
                </button>
  
        </div>
        
    <div class="conteiner">

    
            <div class="card">
                <figure>
                    <span class="heart">
                        <i class="bi bi-heart-pulse-fill"></i>
                    </span>
                </figure>
                <div id="g2" class="gauge" style="width:180px; height:120px;"></div>
            </div>
            <div class="card">
                <figure>
                    <span>
                        <i class="bi bi-thermometer-half"></i>
                    </span>
                </figure>
                <div id="g3" class="gauge" style="width: 180px; height: 120px;"></div>                
            </div>

           
            
    </div>
    <div class="titulo_secundario">
            <h3>graphic</h3>
            <div id="chart"></div>
    </div>
 
    <!--<script src="https://cdn.jsdelivr.net/npm/chart.js@4.5.0/dist/chart.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/luxon"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-luxon"></script>-->
    <!-- TradingView Lightweight Charts (reemplaza ApexCharts) -->
    <script src="https://unpkg.com/lightweight-charts@3.8.0/dist/lightweight-charts.standalone.production.js"></script>
    <script src="javaScript/justgage-1.2.2/raphael-2.1.4.min.js"></script>
    <script src="javaScript/justgage-1.2.2/justgage.js"></script>
    <script src="javaScript/justgage-1.2.2/main.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/notyf@3/notyf.min.js"></script>
    
    <script  src="firebase.js"    type="module"></script>

    <script>
        
    
        var g2;
        window.onload = function(){
        var g2 = new JustGage({
          id: "g2",
          value: 0,
          min: 50,
          max: 160,
          gaugeWidthScale: 0.6,
          counter: true,
          title: "BPM",
          label: "bpm",
          formatNumber: true,
          levelColors: [
            "#dc3545",
            "#ffc107",
            "#28a745"
        ],
        startAnimationTime: 2000,
        startAnimationType: ">",
        refreshAnimationTime: 1000,
        Symbol:'%',
            pointer: false,
            pointerOptions: {
            toplength: -15,
            bottomlength: 10,
            bottomwidth: 12,
            color: '#8e8e93',
            stroke: '#ffffff',
            stroke_width: 3,
            stroke_linecap: 'round'
        },
        counter:true,
        
        });
        var g3 = new JustGage({
            id: "g3",
            value: 0,
            min:0,
            formatNumber:true,
            max:300000,
            gaugeWidthScale: 0.6,
            Symbol:'%',
            pointer:false,
            pointerOptions: {
                toplength: -15,
                bottomlength: 10,
                bottomwidth: 12,
                color: '#8e8e93',
                stroke: '#ffffff',
                stroke_width: 3,
                stroke_linecap: 'round'
            },

            title:"SpO2",
            label:"Sp02",
            counter:true,

        })
        setInterval(function() {
            fetch("/api/ver").then((response)=>{
                    return response.json()
            }).then((data) => {
                if(data.sensor_IR !== undefined && data.sensor_pulso_cardiaco !== undefined){
                g3.refresh(data.sensor_IR);
                g2.refresh(data.sensor_pulso_cardiaco);        
                }
               
            })
        }, 3500);

      };


            // Usamos TradingView Lightweight Charts para mostrar la serie temporal (BPM)
            (function(){
                const container = document.getElementById('chart');
                container.style.width = '100%';
                container.style.height = '300px';

                const chart = LightweightCharts.createChart(container, {
                    layout: { backgroundColor: '#ffffff', textColor: '#000' },
                    rightPriceScale: { visible: true },
                    timeScale: { timeVisible: true, secondsVisible: false }
                });

                const lineSeries = chart.addLineSeries({ color: '#0000FF' });

                const loadData = () => {
                    return fetch('/api/datosBPM')
                        .then(r => r.json())
                        .then(data => data.map(d => {
                            const ms = new Date(`${d.fecha} ${d.hora}`).getTime();
                            return { time: Math.floor(ms / 1000), value: d.sensor_pulso_cardiaco };
                        }).filter(p => p.value !== null && p.value !== undefined));
                };

                loadData().then(points => {
                    const last = points.slice(Math.max(0, points.length - 50));
                    lineSeries.setData(last);
                    if (last.length) {
                        chart.timeScale().setVisibleRange({ from: last[0].time, to: last[last.length - 1].time });
                    }
                }).catch(err => console.error('Error cargando datosBPM:', err));

                // Actualizar periódicamente
                setInterval(()=>{
                    loadData().then(points => {
                        const last = points.slice(Math.max(0, points.length - 50));
                        lineSeries.setData(last);
                    }).catch(e=>console.error(e));
                }, 5000);

                // Ajuste responsive sencillo
                window.addEventListener('resize', () => {
                    chart.applyOptions({ width: container.clientWidth });
                });

                // Tooltip flotante (estilo documentación Lightweight Charts)
                const toolTip = document.createElement('div');
                toolTip.className = 'lw-tooltip';
                Object.assign(toolTip.style, {
                    position: 'absolute',
                    display: 'none',
                    padding: '8px 10px',
                    boxSizing: 'border-box',
                    fontSize: '12px',
                    textAlign: 'left',
                    zIndex: 1000,
                    pointerEvents: 'none',
                    borderRadius: '6px',
                    background: 'rgba(0,0,0,0.85)',
                    color: 'white',
                    border: '1px solid rgba(41,98,255,0.6)',
                    boxShadow: '0 2px 8px rgba(0,0,0,0.6)',
                    fontFamily: "-apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial",
                });
                toolTip.innerHTML = '<div style="font-size:11px;color:#9fb1ff;margin-bottom:4px;">BPM</div><div style="font-size:20px;font-weight:700;color:white;line-height:1">--</div><div style="font-size:11px;color:#cfd7ff;margin-top:6px;">--</div>';
                container.style.position = container.style.position || 'relative';
                container.appendChild(toolTip);

                chart.subscribeCrosshairMove(param => {
                    if (!param || !param.time || !param.point) {
                        toolTip.style.display = 'none';
                        return;
                    }

                    // obtener la hora legible
                    let dateStr;
                    if (typeof param.time === 'number') {
                        dateStr = new Date(param.time * 1000).toLocaleString();
                    } else {
                        const d = new Date(param.time);
                        dateStr = Number.isNaN(d.getTime()) ? String(param.time) : d.toLocaleString();
                    }

                    // obtener el precio/value del series
                    let price;
                    try {
                        if (param.seriesPrices && typeof param.seriesPrices.get === 'function') {
                            const sp = param.seriesPrices.get(lineSeries);
                            if (sp !== undefined && sp !== null) {
                                if (typeof sp === 'number') price = sp;
                                else if (sp.value !== undefined) price = sp.value;
                                else if (sp.close !== undefined) price = sp.close;
                            }
                        }
                    } catch (e) {}

                    if (price === undefined && param.seriesData && typeof param.seriesData.get === 'function') {
                        const sd = param.seriesData.get(lineSeries);
                        if (sd) price = sd.value !== undefined ? sd.value : sd.close;
                    }

                    if (price === undefined) {
                        toolTip.style.display = 'none';
                        return;
                    }

                    // actualizar contenido
                    const parts = toolTip.children;
                    parts[1].textContent = Math.round(price * 100) / 100;
                    parts[2].textContent = dateStr;
                    toolTip.style.display = 'block';

                    // posicionar tooltip cerca del punto
                    const coordY = lineSeries.priceToCoordinate(price);
                    if (coordY === null) return;
                    const ttW = 140, ttH = 72, ttMargin = 10;
                    const left = Math.max(0, Math.min(container.clientWidth - ttW, param.point.x - ttW / 2));
                    let top = coordY - ttH - ttMargin;
                    if (top < 0) top = Math.max(0, Math.min(container.clientHeight - ttH - ttMargin, coordY + ttMargin));
                    toolTip.style.left = left + 'px';
                    toolTip.style.top = top + 'px';
                });
            })();
     
       

        
    </script>
    

</body>
</html>
